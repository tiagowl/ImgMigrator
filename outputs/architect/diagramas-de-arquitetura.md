# Diagramas de Arquitetura - Sistema de Migração iCloud para Google Drive

## 1. Visão Geral do Sistema

### 1.1 Arquitetura de Alto Nível

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENTE (Browser)                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Frontend (React/Vue)                                │  │
│  │  - Dashboard                                         │  │
│  │  - Formulários                                       │  │
│  │  - Visualização de Progresso                         │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTPS
                        │ WebSocket (progresso)
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    BACKEND (Python)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API REST (FastAPI/Flask)                            │  │
│  │  - Autenticação                                      │  │
│  │  - Gerenciamento de Credenciais                      │  │
│  │  - Controle de Migrações                             │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Worker (Background Jobs)                             │  │
│  │  - Processamento de Migrações                        │  │
│  │  - Download iCloud                                   │  │
│  │  - Upload Google Drive                               │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Serviços                                            │  │
│  │  - iCloud Service                                    │  │
│  │  - Google Drive Service                              │  │
│  │  - Encryption Service                                 │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    BANCO DE DADOS                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  SQLite                                              │  │
│  │  - users                                             │  │
│  │  - credentials                                       │  │
│  │  - migrations                                        │  │
│  │  - migration_logs                                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  SERVIÇOS EXTERNOS                           │
│  ┌──────────────┐              ┌──────────────┐          │
│  │  iCloud API  │              │ Google Drive  │          │
│  │              │              │     API      │          │
│  │  - Auth      │              │  - OAuth 2.0 │          │
│  │  - Photos    │              │  - Upload    │          │
│  └──────────────┘              └──────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Arquitetura de Componentes

### 2.1 Componentes Principais

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND LAYER                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Dashboard  │  │  Credentials │  │   Migration  │   │
│  │   Component  │  │   Component  │  │   Component   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                 │                 │            │
│         └─────────────────┼─────────────────┘            │
│                          │                               │
│                   ┌───────▼───────┐                       │
│                   │  API Client  │                       │
│                   │   (Axios)     │                       │
│                   └───────┬───────┘                       │
└───────────────────────────┼───────────────────────────────┘
                            │ HTTP/WebSocket
┌───────────────────────────▼───────────────────────────────┐
│                    BACKEND LAYER                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              API Routes (FastAPI)                   │  │
│  │  /auth          /credentials    /migrations        │  │
│  │  /oauth/callback /migrations/:id/progress         │  │
│  └───────────────────┬─────────────────────────────────┘  │
│                      │                                      │
│         ┌────────────┼────────────┐                        │
│         │            │            │                        │
│  ┌──────▼──────┐ ┌──▼──────┐ ┌──▼──────────┐            │
│  │  Auth       │ │Credential│ │ Migration   │            │
│  │  Controller │ │Controller│ │ Controller  │            │
│  └──────┬──────┘ └──┬───────┘ └──┬──────────┘            │
│         │            │            │                        │
│  ┌──────▼────────────▼────────────▼──────────┐          │
│  │           Service Layer                    │          │
│  │  - AuthService                             │          │
│  │  - CredentialService                       │          │
│  │  - MigrationService                        │          │
│  │  - EncryptionService                       │          │
│  └──────┬─────────────────────────────────────┘          │
│         │                                                 │
│  ┌──────▼─────────────────────────────────────┐          │
│  │         Repository Layer                    │          │
│  │  - UserRepository                          │          │
│  │  - CredentialRepository                    │          │
│  │  - MigrationRepository                     │          │
│  └──────┬─────────────────────────────────────┘          │
│         │                                                 │
│  ┌──────▼─────────────────────────────────────┐          │
│  │         Database (SQLite)                  │          │
│  └────────────────────────────────────────────┘          │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │         Background Worker (Celery/RQ)              │  │
│  │  - MigrationProcessor                              │  │
│  │  - iCloudDownloader                                │  │
│  │  - GoogleDriveUploader                             │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Fluxo de Dados

### 3.1 Fluxo de Autenticação OAuth (Google Drive)

```
┌─────────┐         ┌──────────┐         ┌─────────────┐         ┌──────────────┐
│ Cliente │         │ Backend  │         │   Google   │         │    Banco     │
│         │         │   API    │         │   OAuth    │         │   de Dados   │
└────┬────┘         └────┬─────┘         └──────┬──────┘         └──────┬───────┘
     │                   │                      │                       │
     │ 1. GET /oauth/    │                      │                       │
     │    google/init    │                      │                       │
     ├──────────────────►│                      │                       │
     │                   │                      │                       │
     │ 2. Redirect URL  │                      │                       │
     │◄──────────────────┤                      │                       │
     │                   │                      │                       │
     │ 3. Redirect       │                      │                       │
     │───────────────────┼─────────────────────►│                       │
     │                   │                      │                       │
     │ 4. User Auth       │                      │                       │
     │◄──────────────────┼──────────────────────┤                       │
     │                   │                      │                       │
     │ 5. Callback       │                      │                       │
     │    /oauth/callback│                      │                       │
     │    ?code=xxx      │                      │                       │
     ├──────────────────►│                      │                       │
     │                   │                      │                       │
     │ 6. Exchange Code  │                      │                       │
     │    for Token      │                      │                       │
     │                   ├─────────────────────►│                       │
     │                   │                      │                       │
     │ 7. Access Token   │                      │                       │
     │                   │◄──────────────────────┤                       │
     │                   │                      │                       │
     │ 8. Save Token     │                      │                       │
     │    (encrypted)    │                      │                       │
     │                   ├──────────────────────────────────────────────►│
     │                   │                      │                       │
     │ 9. Success        │                      │                       │
     │◄──────────────────┤                      │                       │
     │                   │                      │                       │
```

### 3.2 Fluxo de Configuração de Credenciais iCloud

```
┌─────────┐         ┌──────────┐         ┌─────────────┐         ┌──────────────┐
│ Cliente │         │ Backend  │         │   iCloud    │         │    Banco     │
│         │         │   API    │         │     API     │         │   de Dados   │
└────┬────┘         └────┬─────┘         └──────┬──────┘         └──────┬───────┘
     │                   │                      │                       │
     │ 1. POST           │                      │                       │
     │    /credentials   │                      │                       │
     │    {apple_id,     │                      │                       │
     │     password}     │                      │                       │
     ├──────────────────►│                      │                       │
     │                   │                      │                       │
     │ 2. Validate       │                      │                       │
     │    Format         │                      │                       │
     │                   │                      │                       │
     │ 3. Test Auth      │                      │                       │
     │                   ├─────────────────────►│                       │
     │                   │                      │                       │
     │ 4. Auth Result    │                      │                       │
     │                   │◄──────────────────────┤                       │
     │                   │                      │                       │
     │ 5. Encrypt        │                      │                       │
     │    Credentials   │                      │                       │
     │                   │                      │                       │
     │ 6. Save to DB     │                      │                       │
     │    (encrypted)    │                      │                       │
     │                   ├──────────────────────────────────────────────►│
     │                   │                      │                       │
     │ 7. Success        │                      │                       │
     │◄──────────────────┤                      │                       │
     │                   │                      │                       │
```

### 3.3 Fluxo de Migração de Fotos

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│ Cliente │    │ Backend  │    │  Worker  │    │   iCloud    │    │ Google Drive│    │    Banco    │
│         │    │   API    │    │          │    │     API     │    │     API     │    │   de Dados   │
└────┬────┘    └────┬─────┘    └────┬─────┘    └──────┬──────┘    └──────┬───────┘    └──────┬───────┘
     │              │               │                 │                  │                   │
     │ 1. POST      │               │                 │                  │                   │
     │    /migrations│               │                 │                  │                   │
     ├─────────────►│               │                 │                  │                   │
     │              │               │                 │                  │                   │
     │ 2. Create    │               │                 │                  │                   │
     │    Migration │               │                 │                  │                   │
     │    Record    │               │                 │                  │                   │
     │              ├───────────────────────────────────────────────────────────────────────►│
     │              │               │                 │                  │                   │
     │ 3. Queue Job │               │                 │                  │                   │
     │              ├──────────────►│                 │                  │                   │
     │              │               │                 │                  │                   │
     │ 4. Status    │               │                 │                  │                   │
     │    Pending   │               │                 │                  │                   │
     │◄─────────────┤               │                 │                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 5. Start        │                  │                   │
     │              │               │    Processing   │                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 6. List Photos │                  │                   │
     │              │               ├────────────────►│                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 7. Photos List  │                  │                   │
     │              │               │◄────────────────┤                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 8. For each     │                  │                   │
     │              │               │    photo:       │                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 9. Download    │                  │                   │
     │              │               ├────────────────►│                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 10. Photo Data │                  │                   │
     │              │               │◄────────────────┤                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 11. Upload      │                  │                   │
     │              │               │                 ├──────────────────►│                  │
     │              │               │                 │                  │                   │
     │              │               │ 12. Upload OK   │                  │                   │
     │              │               │                 │◄─────────────────┤                  │
     │              │               │                 │                  │                   │
     │              │               │ 13. Update      │                  │                   │
     │              │               │     Progress    │                  │                   │
     │              │               ├───────────────────────────────────────────────────────►│
     │              │               │                 │                  │                   │
     │ 14. Poll     │               │                 │                  │                   │
     │    Progress  │               │                 │                  │                   │
     ├─────────────►│               │                 │                  │                   │
     │              │               │                 │                  │                   │
     │ 15. Progress │               │                 │                  │                   │
     │◄─────────────┤               │                 │                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 16. Complete    │                  │                   │
     │              │               │                 │                  │                   │
     │              │               │ 17. Update      │                  │                   │
     │              │               │     Status      │                  │                   │
     │              │               ├───────────────────────────────────────────────────────►│
     │              │               │                 │                  │                   │
     │ 18. Final    │               │                 │                  │                   │
     │    Status    │               │                 │                  │                   │
     │◄─────────────┤               │                 │                  │                   │
     │              │               │                 │                  │                   │
```

---

## 4. Arquitetura de Segurança

### 4.1 Camadas de Segurança

```
┌─────────────────────────────────────────────────────────────┐
│                    CAMADA DE APLICAÇÃO                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  HTTPS/TLS 1.3                                       │  │
│  │  - Criptografia em trânsito                         │  │
│  │  - Certificados SSL válidos                         │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Autenticação e Autorização                          │  │
│  │  - Rate Limiting                                     │  │
│  │  - CORS Policy                                       │  │
│  │  - Input Validation                                  │  │
│  └──────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    CAMADA DE DADOS                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Criptografia de Credenciais                         │  │
│  │  - AES-256-GCM                                       │  │
│  │  - Key Management (Environment Variables)            │  │
│  │  - Salt único por credencial                         │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Proteção do Banco de Dados                          │  │
│  │  - SQLite com WAL mode                               │  │
│  │  - Prepared Statements (SQL Injection)               │  │
│  │  - Backup criptografado                              │  │
│  └──────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    CAMADA DE INFRAESTRUTURA                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Segurança de Rede                                   │  │
│  │  - Firewall                                          │  │
│  │  - DDoS Protection                                   │  │
│  │  - VPN para acesso administrativo                     │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. Arquitetura de Deployment

### 5.1 Estrutura de Deployment (Produção)

```
┌─────────────────────────────────────────────────────────────┐
│                    LOAD BALANCER                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Nginx / Cloudflare                                   │  │
│  │  - SSL Termination                                    │  │
│  │  - Rate Limiting                                      │  │
│  │  - Static Files                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  App Server  │ │  App Server  │ │  App Server   │
│   (Python)   │ │   (Python)   │ │   (Python)    │
│              │ │              │ │               │
│  - FastAPI   │ │  - FastAPI   │ │  - FastAPI    │
│  - Gunicorn  │ │  - Gunicorn  │ │  - Gunicorn   │
└──────┬───────┘ └──────┬───────┘ └──────┬────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              MESSAGE QUEUE (Redis/RabbitMQ)                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Worker 1   │ │   Worker 2   │ │   Worker 3   │
│   (Celery)   │ │   (Celery)   │ │   (Celery)    │
└──────────────┘ └──────────────┘ └──────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              DATABASE CLUSTER                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  SQLite      │  │  SQLite       │  │  SQLite       │   │
│  │  (Primary)   │  │  (Replica 1)  │  │  (Replica 2)  │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Estrutura de Deployment (Desenvolvimento)

```
┌─────────────────────────────────────────────────────────────┐
│                    DESENVOLVIMENTO LOCAL                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Docker Compose                                      │  │
│  │                                                       │  │
│  │  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │  Backend     │  │  Frontend     │                │  │
│  │  │  (Python)    │  │  (React)      │                │  │
│  │  │  :8000       │  │  :3000        │                │  │
│  │  └──────┬───────┘  └──────┬───────┘                │  │
│  │         │                 │                          │  │
│  │  ┌──────▼─────────────────▼───────┐                │  │
│  │  │  SQLite (Volume)                │                │  │
│  │  │  Redis (Queue)                  │                │  │
│  │  └─────────────────────────────────┘                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Diagrama de Sequência: Iniciar Migração

```
Cliente          API          Worker        iCloud API    Google API    Database
  │              │              │              │              │            │
  │ POST /migrations            │              │              │            │
  ├─────────────►│              │              │              │            │
  │              │              │              │              │            │
  │              │ Create Migration Record                    │            │
  │              ├────────────────────────────────────────────►│            │
  │              │              │              │              │            │
  │              │ Queue Job    │              │              │            │
  │              ├─────────────►│              │              │            │
  │              │              │              │              │            │
  │              │ Return 202   │              │              │            │
  │◄─────────────┤              │              │              │            │
  │              │              │              │              │            │
  │              │              │ Process Job  │              │            │
  │              │              │              │              │            │
  │              │              │ List Photos │              │            │
  │              │              ├─────────────►│              │            │
  │              │              │              │              │            │
  │              │              │ Photos List │              │            │
  │              │              │◄─────────────┤              │            │
  │              │              │              │              │            │
  │              │              │ For each photo:             │            │
  │              │              │              │              │            │
  │              │              │ Download Photo             │            │
  │              │              ├─────────────►│              │            │
  │              │              │              │              │            │
  │              │              │ Photo Data   │              │            │
  │              │              │◄─────────────┤              │            │
  │              │              │              │              │            │
  │              │              │ Upload Photo  │              │            │
  │              │              │              ├─────────────►│            │
  │              │              │              │              │            │
  │              │              │ Upload OK    │              │            │
  │              │              │              │◄─────────────┤            │
  │              │              │              │              │            │
  │              │              │ Update Progress             │            │
  │              │              ├─────────────────────────────►│            │
  │              │              │              │              │            │
  │ GET /migrations/:id/progress│              │              │            │
  ├─────────────►│              │              │              │            │
  │              │              │              │              │            │
  │              │ Get Progress│              │              │            │
  │              │◄────────────────────────────┼──────────────┼───────────┤
  │              │              │              │              │            │
  │              │ Return Progress             │              │            │
  │◄─────────────┤              │              │              │            │
  │              │              │              │              │            │
  │              │              │ Complete     │              │            │
  │              │              │              │              │            │
  │              │              │ Update Status│              │            │
  │              │              ├─────────────────────────────►│            │
  │              │              │              │              │            │
```

---

## 7. Diagrama de Componentes Detalhado

### 7.1 Backend Components

```
┌─────────────────────────────────────────────────────────────┐
│                    API LAYER                                 │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Auth Routes  │  │ Credential    │  │ Migration    │    │
│  │              │  │ Routes       │  │ Routes       │    │
│  │ - /auth      │  │ - /credentials│  │ - /migrations│    │
│  │ - /oauth/*   │  │ - POST        │  │ - POST       │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │              │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                  CONTROLLER LAYER                           │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Auth         │  │ Credential    │  │ Migration   │    │
│  │ Controller   │  │ Controller   │  │ Controller  │    │
│  │              │  │              │  │             │    │
│  │ - validate() │  │ - create()    │  │ - create()  │    │
│  │ - login()    │  │ - update()    │  │ - get()     │    │
│  │ - oauth()    │  │ - delete()    │  │ - progress()│    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │              │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    SERVICE LAYER                            │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Auth        │  │ Credential   │  │ Migration    │    │
│  │ Service     │  │ Service      │  │ Service      │    │
│  │             │  │              │  │              │    │
│  │ - OAuth     │  │ - Encrypt    │  │ - Validate   │    │
│  │ - Token     │  │ - Decrypt    │  │ - Queue      │    │
│  │ - Validate  │  │ - Store      │  │ - Status     │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │              │
│  ┌──────▼─────────────────▼─────────────────▼───────┐   │
│  │         External Service Adapters                  │   │
│  │  - iCloudAdapter                                   │   │
│  │  - GoogleDriveAdapter                              │   │
│  │  - EncryptionAdapter                              │   │
│  └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                  REPOSITORY LAYER                           │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ User        │  │ Credential   │  │ Migration    │    │
│  │ Repository  │  │ Repository   │  │ Repository   │    │
│  │             │  │              │  │              │    │
│  │ - find()    │  │ - save()     │  │ - create()   │    │
│  │ - create()  │  │ - find()     │  │ - update()   │    │
│  │ - update()  │  │ - delete()   │  │ - find()     │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │              │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    DATABASE (SQLite)                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. Notas de Implementação

### 8.1 Tecnologias Recomendadas

**Backend:**
- FastAPI (performance, async, auto-docs)
- SQLAlchemy (ORM)
- Celery ou RQ (background jobs)
- Redis (message queue, cache)

**Frontend:**
- React ou Vue.js
- Axios (HTTP client)
- Socket.io (WebSocket para progresso)

**Infraestrutura:**
- Docker (containerização)
- Nginx (reverse proxy)
- Gunicorn (WSGI server)

### 8.2 Padrões Arquiteturais

- **MVC/MVP:** Separação de responsabilidades
- **Repository Pattern:** Abstração de dados
- **Service Layer:** Lógica de negócio
- **Adapter Pattern:** Integrações externas
- **Queue Pattern:** Processamento assíncrono

---

**Documento gerado em:** [Data atual]  
**Versão:** 1.0  
**Status:** Pronto para implementação



